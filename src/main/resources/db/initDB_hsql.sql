DROP TABLE money_transfer IF EXISTS;
DROP TABLE account IF EXISTS;
DROP TABLE currency IF EXISTS;
DROP SEQUENCE global_seq IF EXISTS;

CREATE SEQUENCE GLOBAL_SEQ AS INTEGER START WITH 100000;

CREATE TABLE currency
(
  id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
  iso_currency_code VARCHAR(3) NOT NULL,
  name VARCHAR(255)
);

CREATE TABLE account
(
  id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
  name VARCHAR(255),
  registered TIMESTAMP DEFAULT now(),
  enabled BOOLEAN DEFAULT TRUE,
  amount NUMERIC(13,4),
  currency_id INTEGER NOT NULL,
  FOREIGN KEY ( currency_id ) REFERENCES currency ( id )
);
CREATE INDEX FK_ACCOUNT_CURRENCY_ID_CURRENCY ON account ( currency_id );

CREATE TABLE money_transfer
(
  id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
  sender_id INTEGER NOT NULL,
  recipient_id INTEGER NOT NULL,
  operation_date TIMESTAMP DEFAULT now(),
  source_currency_units NUMERIC(13,4),
  target_currency_units NUMERIC(13,4),
  FOREIGN KEY ( sender_id ) REFERENCES ACCOUNT ( id ) ON DELETE CASCADE,
  FOREIGN KEY ( recipient_id ) REFERENCES ACCOUNT ( id ) ON DELETE CASCADE
);
CREATE INDEX MONEY_TRANSFER_SENDER_ID_RECIPIENT_ID_DATE_IDX ON money_transfer(sender_id, recipient_id, operation_date);